<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Map - Jacobi Iteration Equalizer</title>
    <link rel="stylesheet" href="styles/legacy.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .codemap-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .codemap-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--brass);
        }

        .codemap-header h1 {
            margin: 0;
            color: var(--brass);
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border: 2px solid var(--brass);
            border-radius: 5px;
            cursor: pointer;
            background: transparent;
            color: var(--brass);
            font-family: var(--font-main);
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-button:hover {
            background: var(--brass);
            color: var(--dark-wood);
        }

        .codemap-visualization {
            background: var(--cream);
            border: 2px solid var(--dark-wood);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            min-height: 600px;
        }

        .modern-theme .codemap-visualization {
            background: var(--modern-bg);
            border-color: var(--modern-border);
        }

        .modern-theme .codemap-header {
            border-bottom-color: var(--modern-accent);
        }

        .modern-theme .codemap-header h1 {
            color: var(--modern-accent);
        }

        .modern-theme .back-button {
            border-color: var(--modern-accent);
            color: var(--modern-accent);
        }

        .modern-theme .back-button:hover {
            background: var(--modern-accent);
            color: var(--modern-bg);
        }

        #codemap-svg {
            width: 100%;
            height: 100%;
            min-height: 600px;
        }

        .node {
            cursor: pointer;
        }

        .node circle {
            stroke: #fff;
            stroke-width: 2px;
        }

        .node text {
            font-size: 12px;
            fill: #333;
            pointer-events: none;
            font-family: var(--font-main);
        }

        .link {
            stroke: #999;
            stroke-opacity: 0.6;
            stroke-width: 2px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
            font-family: var(--font-main);
            max-width: 250px;
        }

        .legend {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0,0,0,0.05);
            border-radius: 5px;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #fff;
        }

        .legend-label {
            font-size: 12px;
            color: #333;
            font-family: var(--font-main);
        }

        .modern-theme .legend-label {
            color: var(--modern-text);
        }

        .modern-theme .node text {
            fill: var(--modern-text);
        }
    </style>
</head>
<body>
    <div class="container codemap-container">
        <div class="codemap-header">
            <h1>üìä Project Code Map</h1>
            <a href="index.html" class="back-button">
                <span>‚Üê</span>
                <span>Back to App</span>
            </a>
        </div>

        <div class="codemap-visualization">
            <svg id="codemap-svg"></svg>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #e74c3c;"></div>
                <span class="legend-label">HTML Files</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #3498db;"></div>
                <span class="legend-label">JavaScript Files</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #2ecc71;"></div>
                <span class="legend-label">CSS Files</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #9b59b6;"></div>
                <span class="legend-label">Test Files</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #f39c12;"></div>
                <span class="legend-label">Config Files</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #95a5a6;"></div>
                <span class="legend-label">Documentation</span>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Project structure data
        const projectData = {
            nodes: [
                // Core HTML
                { id: "index.html", type: "html", group: 1, size: 25, description: "Main application entry point" },
                
                // Core JavaScript
                { id: "src/main.js", type: "js", group: 2, size: 30, description: "Main application logic (2951 lines)" },
                { id: "stateManager.js", type: "js", group: 2, size: 22, description: "State management system" },
                { id: "dist/stateManager.bundle.js", type: "js", group: 2, size: 20, description: "Bundled state manager" },
                { id: "audio.js", type: "js", group: 2, size: 18, description: "Audio system for feedback" },
                
                // CSS
                { id: "styles.css", type: "css", group: 3, size: 28, description: "All application styles" },
                
                // Test Files
                { id: "math.test.js", type: "test", group: 4, size: 15, description: "Math utilities tests" },
                { id: "stateManager.test.js", type: "test", group: 4, size: 15, description: "State manager tests" },
                { id: "utils.test.js", type: "test", group: 4, size: 15, description: "Utility functions tests" },
                { id: "setup.js", type: "test", group: 4, size: 12, description: "Test setup configuration" },
                
                // Config Files
                { id: "package.json", type: "config", group: 5, size: 18, description: "NPM package configuration" },
                { id: "vitest.config.js", type: "config", group: 5, size: 15, description: "Vitest test configuration" },
                
                // Documentation
                { id: "prd.md", type: "doc", group: 6, size: 14, description: "Product requirements document" },
                { id: "feature.md", type: "doc", group: 6, size: 14, description: "Feature documentation" },
                { id: "feature-todo.md", type: "doc", group: 6, size: 14, description: "Feature todo list" },
                { id: "STATE_MANAGEMENT.md", type: "doc", group: 6, size: 16, description: "State management documentation" },
                { id: "DESIGN_STYLE_GUIDE.md", type: "doc", group: 6, size: 16, description: "Design style guide" },
                { id: "test-plan.md", type: "doc", group: 6, size: 14, description: "Test plan documentation" },
                
                // External Libraries
                { id: "katex", type: "lib", group: 7, size: 20, description: "KaTeX math rendering library" },
            ],
            links: [
                // HTML dependencies
                { source: "index.html", target: "src/main.js", type: "script" },
                { source: "index.html", target: "styles.css", type: "stylesheet" },
                { source: "index.html", target: "dist/stateManager.bundle.js", type: "script" },
                { source: "index.html", target: "audio.js", type: "script" },
                { source: "index.html", target: "katex", type: "library" },
                
                // JavaScript dependencies
                { source: "src/main.js", target: "stateManager.js", type: "import" },
                { source: "dist/stateManager.bundle.js", target: "stateManager.js", type: "bundle" },
                { source: "src/main.js", target: "audio.js", type: "uses" },
                
                // Test dependencies
                { source: "math.test.js", target: "src/main.js", type: "tests" },
                { source: "stateManager.test.js", target: "stateManager.js", type: "tests" },
                { source: "utils.test.js", target: "src/main.js", type: "tests" },
                { source: "math.test.js", target: "setup.js", type: "uses" },
                { source: "stateManager.test.js", target: "setup.js", type: "uses" },
                { source: "utils.test.js", target: "setup.js", type: "uses" },
                
                // Config dependencies
                { source: "vitest.config.js", target: "package.json", type: "config" },
                
                // Documentation references
                { source: "feature.md", target: "main.js", type: "documents" },
                { source: "STATE_MANAGEMENT.md", target: "stateManager.js", type: "documents" },
                { source: "DESIGN_STYLE_GUIDE.md", target: "styles.css", type: "documents" },
            ]
        };

        // Color mapping by file type
        const colorMap = {
            html: "#e74c3c",
            js: "#3498db",
            css: "#2ecc71",
            test: "#9b59b6",
            config: "#f39c12",
            doc: "#95a5a6",
            lib: "#e67e22"
        };

        // Setup SVG
        const width = document.querySelector('.codemap-visualization').clientWidth - 40;
        const height = 600;

        const svg = d3.select("#codemap-svg")
            .attr("width", width)
            .attr("height", height);

        // Create tooltip
        const tooltip = d3.select("#tooltip");

        // Create force simulation
        const simulation = d3.forceSimulation(projectData.nodes)
            .force("link", d3.forceLink(projectData.links)
                .id(d => d.id)
                .distance(d => {
                    // Adjust link distance based on type
                    if (d.type === "script" || d.type === "stylesheet") return 80;
                    if (d.type === "tests") return 100;
                    return 120;
                }))
            .force("charge", d3.forceManyBody().strength(-400))
            .force("center", d3.forceCenter(width / 2, height / 2))
            .force("collision", d3.forceCollide().radius(d => d.size + 10));

        // Create links
        const link = svg.append("g")
            .selectAll("line")
            .data(projectData.links)
            .enter().append("line")
            .attr("class", "link")
            .attr("stroke-width", d => {
                if (d.type === "script" || d.type === "stylesheet") return 3;
                return 2;
            })
            .attr("stroke-opacity", d => {
                if (d.type === "script" || d.type === "stylesheet") return 0.8;
                return 0.4;
            });

        // Create nodes
        const node = svg.append("g")
            .selectAll("g")
            .data(projectData.nodes)
            .enter().append("g")
            .attr("class", "node")
            .call(d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended));

        // Add circles to nodes
        node.append("circle")
            .attr("r", d => d.size)
            .attr("fill", d => colorMap[d.type] || "#95a5a6")
            .on("mouseover", function(event, d) {
                d3.select(this)
                    .attr("r", d.size * 1.3)
                    .attr("stroke-width", 3);
                
                tooltip
                    .style("opacity", 1)
                    .html(`<strong>${d.id}</strong><br/>${d.description || d.type}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 10) + "px");
            })
            .on("mouseout", function(event, d) {
                d3.select(this)
                    .attr("r", d.size)
                    .attr("stroke-width", 2);
                tooltip.style("opacity", 0);
            });

        // Add labels to nodes
        node.append("text")
            .text(d => d.id)
            .attr("dx", d => d.size + 5)
            .attr("dy", 4)
            .attr("font-size", "11px")
            .attr("fill", "#333");

        // Update positions on simulation tick
        simulation.on("tick", () => {
            link
                .attr("x1", d => d.source.x)
                .attr("y1", d => d.source.y)
                .attr("x2", d => d.target.x)
                .attr("y2", d => d.target.y);

            node
                .attr("transform", d => `translate(${d.x},${d.y})`);
        });

        // Drag functions
        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = document.querySelector('.codemap-visualization').clientWidth - 40;
            svg.attr("width", newWidth);
            simulation.force("center", d3.forceCenter(newWidth / 2, height / 2));
            simulation.alpha(1).restart();
        });
    </script>
</body>
</html>

